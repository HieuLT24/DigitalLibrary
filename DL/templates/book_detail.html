{% extends 'base.html' %}
{% block title %}{{ book.title }}{% endblock %}

{% block content %}
<style>
.book-detail-wrapper{
  display:flex;
  gap:24px;
  align-items:flex-start;
  flex-wrap:wrap;
}
.book-left{ width:270px; max-width:100%; }
.book-left .cover-box{
  background:#f4f4f4; border:1px solid #d6d6d6; border-radius:4px;
  padding:6px; text-align:center;
}
.book-left .cover-box img{
  width:100%; height:auto; display:block; border-radius:2px; object-fit:cover;
}

/* Nút mượn (1 vị trí duy nhất) */
.btn-borrow{
  display:block; width:100%; margin-top:8px;
  background:#00b4d8; border:none; color:#fff; font-weight:600;
  padding:10px 14px; border-radius:4px; cursor:pointer;
  transition:.15s; text-align:center; text-decoration:none;
  font-size:14px; letter-spacing:.3px;
}
.btn-borrow:hover{ background:#0293b0; color:#fff; }
.btn-borrow.disabled{
  background:#adb5bd; cursor:not-allowed; pointer-events:none;
}
.btn-borrow.borrowing{ background:#006d77; }
.btn-borrow.approved{ background:#2e7d32; }
.btn-borrow.approved:hover{ background:#286528; }
.btn-borrow.login-link{ background:#555; }
.btn-borrow.login-link:hover{ background:#333; }

.book-right{ flex:1; min-width:320px; display:flex; flex-direction:column; gap:14px; }

.summary-card{
  border:1px solid #bfc9cf; border-radius:4px; padding:14px 18px 12px; background:#fdfefe;
}
.summary-card h2{ font-size:20px; margin:0 0 10px; font-weight:600; }
.summary-grid{
  display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  gap:6px 28px; font-size:13px; line-height:1.45;
}
.summary-item{ display:flex; justify-content:space-between; gap:12px; white-space:nowrap; }
.summary-item span.label{ font-weight:500; color:#333; }
.summary-item span.value{ text-align:right; font-weight:500; color:#111; }

.badge-status{
  display:inline-block; padding:3px 8px; border-radius:12px; font-size:11px;
  font-weight:600; letter-spacing:.3px; background:#adb5bd; color:#fff;
  vertical-align:middle; margin-left:6px;
}
.badge-status.available{ background:#2dba4e; }

.spec-card{
  border:1px solid #1d2d35; border-radius:4px; overflow:hidden;
  background:#fff; font-size:13px;
}
.spec-table{ width:100%; border-collapse:collapse; }
.spec-table th, .spec-table td{
  padding:10px 14px; vertical-align:middle; border-bottom:1px solid #d6d6d6;
}
.spec-table tr:last-child th, .spec-table tr:last-child td{ border-bottom:none; }
.spec-table th{ width:190px; font-weight:600; background:#efefef; }
.spec-table td{ font-weight:500; }

.description-block{
  margin-top:16px; border:1px solid #000; border-radius:4px;
  padding:14px 16px 18px; background:#fff; font-size:13px; line-height:1.55;
}
.description-block h3{ font-size:15px; margin:0 0 10px; font-weight:600; }

@media (max-width: 720px){
  .book-detail-wrapper{ flex-direction:column; }
  .book-left{ width:100%; max-width:350px; }
  .summary-item{ flex-direction:column; align-items:flex-start; white-space:normal; }
  .summary-item span.value{ text-align:left; }
}
</style>
{% include 'partials/header.html' %}
<div class="book-detail-wrapper">
  <div class="book-left">
    <div class="cover-box">
      {% if book.image %}
        <img src="{{ book.image }}" alt="Bìa sách {{ book.title }}">
      {% else %}
        <img src="{{ url_for('static', filename='img/placeholder-cover.svg') }}" alt="Bìa sách">
      {% endif %}
    </div>

    {# -------- NÚT DUY NHẤT: LOGIC THEO TRẠNG THÁI -------- #}
    {% if current_user.is_authenticated %}
      {% set st = user_state %}
      {# Đang mượn #}
      {% if st and st.is_borrowing %}
        <button class="btn-borrow borrowing disabled" disabled>Đang mượn</button>

      {# Yêu cầu đang chờ #}
      {% elif st and st.request_status == 'pending' %}
        <button class="btn-borrow disabled" disabled>Đang chờ duyệt</button>

      {# Yêu cầu đã duyệt - có thể cho user bấm để xem danh sách yêu cầu #}
      {% elif st and st.request_status == 'approved' %}
        <a class="btn-borrow approved" href="{{ url_for('user.request_list') }}">Đã duyệt - Xem</a>

      {# Chưa có yêu cầu/slip #}
      {% else %}
        {% if book.quantity is not none and book.quantity <= 0 %}
          <button class="btn-borrow disabled" disabled>Hết sách</button>
        {% else %}
          <form method="post" action="{{ url_for('main.request_borrow', book_id=book.book_id) }}">
            <button type="submit" class="btn-borrow">Đăng ký mượn sách</button>
          </form>
        {% endif %}
      {% endif %}
    {% else %}
      <a class="btn-borrow login-link" href="{{ url_for('auth.login', next=request.path) }}">Đăng nhập để mượn</a>
    {% endif %}
  </div>

  <div class="book-right">
    <div class="summary-card">
      <h2>{{ book.title }}
        {% if book.status %}
          <span class="badge-status {{ 'available' if book.status=='available' else '' }}">
            {{ 'Có sẵn' if book.status=='available' else book.status }}
          </span>
        {% endif %}
      </h2>
      <div class="summary-grid">
        <div class="summary-item">
          <span class="label">Tác giả:</span>
          <span class="value">{{ book.author.name if book.author else '—' }}</span>
        </div>
        <div class="summary-item">
          <span class="label">Danh mục:</span>
          <span class="value">{{ book.category.name if book.category else '—' }}</span>
        </div>
        <div class="summary-item">
          <span class="label">Nhà xuất bản:</span>
          <span class="value">{{ book.publisher or '—' }}</span>
        </div>
        <div class="summary-item">
          <span class="label">Năm XB:</span>
          <span class="value">{{ book.publish_year or '—' }}</span>
        </div>
        <div class="summary-item">
          <span class="label">Ngôn ngữ:</span>
          <span class="value">{{ book.language or '—' }}</span>
        </div>
        <div class="summary-item">
          <span class="label">ISBN:</span>
          <span class="value">{{ book.isbn or '—' }}</span>
        </div>
        <div class="summary-item">
          <span class="label">Số lượng còn:</span>
          <span class="value">{{ book.quantity if book.quantity is not none else '—' }}</span>
        </div>
        <div class="summary-item">
          <span class="label">Vị trí:</span>
          <span class="value">{{ book.library_location or '—' }}</span>
        </div>
      </div>
    </div>

    <div class="spec-card">
      <table class="spec-table">
        <tr>
          <th>Tác giả</th>
          <td>{{ book.author.name if book.author else '—' }}</td>
        </tr>
        <tr>
          <th>Danh mục</th>
          <td>{{ book.category.name if book.category else '—' }}</td>
        </tr>
        <tr>
          <th>Nhà xuất bản</th>
          <td>{{ book.publisher or '—' }}</td>
        </tr>
        <tr>
          <th>Năm xuất bản</th>
          <td>{{ book.publish_year or '—' }}</td>
        </tr>
        <tr>
          <th>Ngôn ngữ</th>
          <td>{{ book.language or '—' }}</td>
        </tr>
        <tr>
          <th>ISBN</th>
          <td>{{ book.isbn or '—' }}</td>
        </tr>
        <tr>
          <th>Trạng thái</th>
          <td>{{ 'Có sẵn' if book.status=='available' else (book.status or '—') }}</td>
        </tr>
        <tr>
          <th>Số lượng còn</th>
          <td>{{ book.quantity if book.quantity is not none else '—' }}</td>
        </tr>
        <tr>
          <th>Vị trí</th>
          <td>{{ book.library_location or '—' }}</td>
        </tr>
        <tr>
          <th>Trọng lượng (gr)</th>
          <td>{{ book.weight or '—' }}</td>
        </tr>
        <tr>
          <th>Kích thước</th>
          <td>{{ book.size or '—' }}</td>
        </tr>
        <tr>
          <th>Số trang</th>
          <td>{{ book.page_count or '—' }}</td>
        </tr>
        <tr>
          <th>Hình thức</th>
          <td>{{ book.cover_type or '—' }}</td>
        </tr>
      </table>
    </div>
  </div>
</div>

<div class="description-block">
  <h3>Mô tả sản phẩm</h3>
  {% if book.description %}
    <p>{{ book.description }}</p>
  {% else %}
    <p>Chưa có mô tả cho sách này.</p>
  {% endif %}
</div>
{% include 'partials/footer.html' %}
{% endblock %}