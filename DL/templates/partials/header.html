<header class="topbar">
    <div class="container topbar-inner">
        <a class="home-icon" href="{{ url_for('main.index') }}" aria-label="Trang chủ"><i class="fa-solid fa-house"></i></a>
        <div class="brand">Trang Chủ</div>
        <div class="search-container" role="search">
            <form class="search" id="searchForm">
                <div class="search-input-wrapper">
                    <input type="search" id="searchInput" placeholder="Tìm kiếm sách..." aria-label="Tìm kiếm">
                    <button type="submit" aria-label="Tìm"><i class="fa-solid fa-magnifying-glass"></i></button>
                </div>
                <div id="searchDropdown" class="search-dropdown d-none">
                    <div id="searchResults" class="search-results">
                    </div>
                    <div class="search-footer">
                        <small class="text-muted">Nhấn Enter để tìm kiếm chi tiết</small>
                    </div>
                </div>
            </form>
        </div>
        <div class="top-actions">
            <a href="#" aria-label="Danh sách chờ duyệt"><i class="fa-solid fa-list-check me-1"></i>Danh sách chờ duyệt</a>
            {% if current_user.is_authenticated and current_user.role == 'admin' %}
            <a href="{{ url_for('admin.admin_index') }}" class="btn btn-sm btn-outline-secondary ms-2" aria-label="Quản trị">
                <i class="fa-solid fa-screwdriver-wrench"></i> Quản trị
            </a>
            {% endif %}
            {% if current_user.is_authenticated %}
            <a href="{{ url_for('user.user_profile') }}" aria-label="Tài khoản"><i class="fa-solid fa-user me-1"></i>Tài khoản</a>
            <a href="{{ url_for('auth.logout') }}" class="btn btn-sm btn-danger ms-2" aria-label="Đăng xuất"><i class="fa-solid fa-right-from-bracket"></i> Đăng xuất</a>
            {% else %}
            <a href="{{ url_for('auth.login') }}" class="btn btn-sm btn-primary ms-2" aria-label="Đăng nhập"><i class="fa-solid fa-right-to-bracket"></i> Đăng nhập</a>
            {% endif %}
        </div>
    </div>
    <div class="topbar-accent"></div>
</header>


<script>
  (function(){
    const searchInput = document.getElementById('searchInput');
    const searchDropdown = document.getElementById('searchDropdown');
    const searchResults = document.getElementById('searchResults');
    const searchForm = document.getElementById('searchForm');
    let debounceTimer = null;

    if (!searchInput) return;

    function showDropdown(){
      searchDropdown.classList.remove('d-none');
    }

    function hideDropdown(){
      searchDropdown.classList.add('d-none');
    }

    function setLoading(){
      searchResults.innerHTML = '<div class="search-loading"><i class="fas fa-spinner fa-spin"></i> Đang tìm kiếm...</div>';
      showDropdown();
    }

    async function fetchQuickResults(q){
      try {
        const url = `/search/quick?q=${encodeURIComponent(q)}&limit=5`;
        const resp = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        const html = await resp.text();
        searchResults.innerHTML = html;
        showDropdown();
      } catch (err) {
        searchResults.innerHTML = '<div class="search-no-results"><i class="fas fa-exclamation-triangle"></i><br>Lỗi tải kết quả</div>';
        showDropdown();
      }
    }

    searchInput.addEventListener('input', function(e){
      const value = e.target.value.trim();
      if (debounceTimer) clearTimeout(debounceTimer);
      if (!value){
        hideDropdown();
        return;
      }
      debounceTimer = setTimeout(() => {
        setLoading();
        fetchQuickResults(value);
      }, 1000);
    });

    searchForm.addEventListener('submit', function(e){
      e.preventDefault();
      const q = searchInput.value.trim();
      if (!q){ hideDropdown(); return; }
      window.location.href = `/search?q=${encodeURIComponent(q)}`;
    });

    document.addEventListener('click', function(e){
      if (!e.target.closest('.search-container')){
        hideDropdown();
      }
    });
  })();
</script>